<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>South Bronx Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Map - Static, always full screen, behind sidebar */
    #map {
      position: fixed !important;
      top: 73px !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: calc(100vh - 73px) !important;
      z-index: 0 !important;
    }
    
    .sidebar{
      position: fixed;
      top: 73px;
      left: 0;
      bottom: 0;
      width: 350px;
      transition: width .22s ease, transform .22s ease;
      z-index: 10;
    }
    .sidebar.collapsed{
      width: 96px;
    }
    .sidebar .panel{display:block}
    .sidebar.collapsed .panel{display:none}
    .sidebar .rail-justify{justify-content:flex-start}
    .sidebar.collapsed .brand-text{display:none}
    
    /* Expand bar - extends from top to bottom on left */
    .expand-bar{
      width: 24px;
      background-color: #e5e7eb;
      cursor: pointer;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
      height: 100%;
    }
    .expand-bar:hover{
      background-color: #9ca3af;
    }
    
    /* Ensure rail buttons have white background with proper width */
    .rail-justify{
      background-color: white;
      min-width: 72px;
      flex-shrink: 0;
    }
    
    /* Clean popup styling - no black outlines */
    .mapboxgl-popup-content{
      padding: 0 !important;
      border-radius: 12px !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
      border: none !important;
    }
    .mapboxgl-popup-close-button{
      font-size: 20px !important;
      padding: 8px !important;
      color: #666 !important;
    }
    .mapboxgl-popup-tip{
      border: none !important;
    }
    
    @media (max-width: 767px){
      .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:40;transform:translateX(-100%)}
      .sidebar.open{transform:translateX(0)}
      .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);z-index:30;display:none}
      .backdrop.show{display:block}
    }
    .debug-panel{
      display: none !important;
      position:fixed;left:8px;bottom:8px;z-index:9999;
      max-width:320px;max-height:40vh;overflow:auto;
      background:#fff;border:1px solid #ddd;border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:8px;font:12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif
    }
    .debug-panel h4{margin:0 0 6px 0;font-size:12px}
    
    /* Disclaimer styling */
    .disclaimer__content{
      max-height: 470px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .disclaimer__item{
      margin-bottom: 16px;
    }
    .disclaimer__item:last-child{
      margin-bottom: 0;
    }
    .disclaimer__item h3{
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin: 0 0 6px 0;
    }
    .disclaimer__item p{
      font-size: 13px;
      line-height: 1.6;
      color: #4b5563;
      margin: 0;
    }
    
    /* Simple PLOS Bar Chart */
    .plos-chart-section {
      margin-top: 16px;
      display: none;
    }
    
    .plos-chart-section.active {
      display: block;
    }
    
    .plos-chart-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Range Slider */
    .plos-slider-container {
      position: relative;
      height: 30px;
      margin-bottom: 20px;
      padding: 0 4px;
    }
    
    .plos-slider-track {
      position: absolute;
      top: 13px;
      left: 4px;
      right: 4px;
      height: 4px;
      background: #ddd;
      border-radius: 2px;
    }
    
    .plos-slider-range {
      position: absolute;
      height: 100%;
      background: #4a90e2;
      border-radius: 2px;
      pointer-events: none;
    }
    
    .plos-slider-handle {
      position: absolute;
      top: 7px;
      width: 16px;
      height: 16px;
      background: #4a90e2;
      border: 2px solid white;
      border-radius: 50%;
      cursor: grab;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transform: translateX(-8px);
      z-index: 10;
    }
    
    .plos-slider-handle:active {
      cursor: grabbing;
    }
    
    .plos-bars-container {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 120px;
      gap: 4px;
      padding: 0 4px;
      margin-top: 8px;
    }
    
    .plos-bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 0;
    }
    
    .plos-bar-column {
      width: 100%;
      border-radius: 2px 2px 0 0;
      transition: opacity 0.2s;
      min-height: 2px;
      border: 1px solid rgba(0,0,0,0.1);
    }
    
    .plos-bar-item.dimmed .plos-bar-column {
      opacity: 0.2;
    }
    
    .plos-bar-label {
      font-size: 10px;
      font-weight: 600;
      color: #555;
      text-align: center;
    }
    
    .plos-bar-value {
      font-size: 8px;
      color: #999;
      text-align: center;
      line-height: 1.2;
    }
    
    /* Map Legends in Sidebar */
    .map-legend {
      margin-top: 16px;
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      display: none;
    }
    
    .map-legend.active {
      display: block;
    }
    
    .legend-title {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .legend-gradient {
      height: 20px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #666;
    }
    
    .legend-items {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 10px;
    }
    
    .legend-color-box {
      width: 24px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    
    .legend-label {
      color: #333;
      font-weight: 500;
      flex: 1;
    }
    
    .legend-value {
      color: #666;
      font-size: 9px;
      margin-left: auto;
    }
  </style>
</head>

<body class="h-screen w-screen overflow-hidden bg-neutral-50">
  
  <!-- Header stretched across the top -->
  <header class="fixed top-0 left-0 right-0 flex items-center justify-between gap-3 p-4 border-b-2 border-black bg-white z-20">
    <div class="flex items-center gap-3">
      <div id="brandLogo" class="shrink-0 grid place-items-center h-10 w-10 rounded-lg bg-white text-white font-bold cursor-pointer" title="Collapse/Expand">
        <img src="./assets/MIT.svg" class="mr-[-40px] scale-[1.3] " >
      </div>
    <!-- <div class="brand-text flex items-center gap-2">
        <img src="./assets/SA+P.svg" class="h-8 ml-[30px] scale-[0.8] "/>
      </div> -->
    <div class="brand-text flex items-center gap-3">
        <img src="./assets/SBX.svg" class="h-8 ml-[55px] scale-[1.3] "/>
      </div>
    </div>
    <div class="flex items-center">
      <img src="./assets/People_S.png" class="h-8 mr-[250px] scale-[1.70]"/>
    </div>
  </header>

  <!-- Main content area: sidebar + map -->
  <div class="relative h-full w-full overflow-hidden">
    <!-- Map - Fixed position, always full screen, behind sidebar -->
    <div id="map"></div>
    
    <!-- Sidebar - Fixed position, overlays map -->
    <aside id="sidebar" class="sidebar bg-white border-r border-neutral-200 shadow-sm flex">
      <!-- Expand/collapse bar - extends to bottom -->
      <div class="expand-bar" title="Click to expand/collapse sidebar"></div>
      
      <nav class="rail-justify flex flex-col items-center gap-2 p-3 border-r border-neutral-200" role="tablist" aria-orientation="vertical">
        <button class="rail-btn h-10 w-10 rounded-lg border border-neutral-300 bg-white text-sm font-bold aria-selected:bg-[#c0c0c0] aria-selected:text-white" aria-selected="true" data-tab="background" role="tab" aria-controls="background" title="Background"> <img src="./assets/home.svg" alt="Background" class="w-8 h-8 ml-[3.5px]"></button>
        <button class="rail-btn h-10 w-10 rounded-lg border border-neutral-300 bg-white text-sm font-bold aria-selected:bg-[#c0c0c0] aria-selected:text-white" data-tab="traffic" role="tab" aria-controls="traffic" title="Traffic Data"><img src="./assets/map.svg" alt="Background" class="w-8 h-8 ml-[3.5px]"></button>
        <button class="rail-btn h-10 w-10 rounded-lg border border-neutral-300 bg-white text-sm font-bold aria-selected:bg-[#c0c0c0] aria-selected:text-white" data-tab="intervention" role="tab" aria-controls="intervention" title="Intervention"><img src="./assets/pencil.svg" alt="Background" class="w-8 h-8 ml-[3.5px]"></button>
      </nav>

      <section class="panel flex-1 overflow-y-auto p-4">
          <!-- Background Tab -->
          <div id="background" class="tab-content space-y-4 text-xs" role="tabpanel">
            <div>
              <h2 class="text-sm font-bold mb-2">Background</h2>
              <p class="text-justify leading-relaxed">
                The South Bronx is shaped by high population density, strong reliance on walking and public transit,
                and the close coexistence of residential, industrial, and transportation infrastructure. Despite high
                pedestrian demand, many streets remain unsafe or uncomfortable due to fast-moving traffic, limited
                pedestrian amenities, and infrastructural barriers such as highways and toll roads. These conditions
                restrict access to services, waterfronts, and public space, making pedestrian analysis essential to
                identifying spatial inequities and design opportunities.
              </p>
            </div>
            
            <div>
              <h2 class="text-sm font-bold mb-2">Objectives</h2>
              <p class="text-justify leading-relaxed">
                  This studio project analyzes pedestrian movement, traffic, and land use in the South Bronx to inform targeted
                  urban design strategies. By integrating pedestrian density, transit accessibility, and network
                  connectivity, the studio identifies priority corridors and underutilized areas for activation. The
                  goal is to improve walkability, safety, and environmental quality while strengthening connections
                  between neighborhoods, transit, commercial areas, and the waterfront.
              </p>
            </div>
          </div>

          <!-- Traffic Data Tab -->
          <div id="traffic" class="tab-content hidden space-y-4 text-xs" role="tabpanel">
            <div>
              <h2 class="text-sm font-bold mb-3">Traffic Data</h2>
              <p class="text-justify leading-relaxed mb-4">
                This section provides access to traffic and pedestrian density data for the South Bronx area.
                Use the layer controls below to visualize different data types on the map.
              </p>
              
              <h3 class="text-xs font-semibold mb-2">Layers</h3>
              <ul class="space-y-2">
                <li class="flex items-center gap-2">
                  <input id="cbPeds" type="checkbox" class="h-4 w-4">
                  <span>Pedestrian Density</span>
                </li>
                <li class="flex items-center gap-2">
                  <input id="cbVehicles" type="checkbox" class="h-4 w-4">
                  <span>Vehicle Density</span>
                </li>
                <li class="flex items-center gap-2">
                  <input id="cbPLOS" type="checkbox" class="h-4 w-4">
                  <span>Pedestrian Level of Service</span>
                </li>
              </ul>
              
              <!-- Pedestrian Density Legend -->
              <div id="pedestrianLegend" class="map-legend">
                <div class="legend-title">Pedestrian Density</div>
                <div class="legend-gradient" style="background: linear-gradient(to right, #FFE5D9, #FFCCB3, #FFB399, #FF9980, #FF8066, #FF664D, #FF4D33, #991F00);"></div>
                <div class="legend-labels">
                  <span>Low (&le;1,000)</span>
                  <span>High (&ge;100,000)</span>
                </div>
              </div>
              
              <!-- Vehicle Traffic Legend -->
              <div id="vehicleLegend" class="map-legend">
                <div class="legend-title">Vehicle Traffic</div>
                <div class="legend-gradient" style="background: linear-gradient(to right, #FFE5D9, #FFCCB3, #FFB399, #FF9980, #FF8066, #FF664D, #FF4D33, #991F00);"></div>
                <div class="legend-labels">
                  <span>Low (&le;100)</span>
                  <span>High (&le;2,000)</span>
                </div>
              </div>
              
              <!-- PLOS Legend -->
              <div id="plosLegend" class="map-legend">
                <div class="legend-title">Level of Service</div>
                <div class="legend-items">
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #00CC00;"></div>
                    <span class="legend-label">A - Excellent</span>
                    <span class="legend-value">0.0-1.5</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #77CC00;"></div>
                    <span class="legend-label">B - Good</span>
                    <span class="legend-value">1.5-2.5</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #CCCC00;"></div>
                    <span class="legend-label">C - Fair</span>
                    <span class="legend-value">2.5-3.5</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #FFCC00;"></div>
                    <span class="legend-label">D - Poor</span>
                    <span class="legend-value">3.5-4.5</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #FF9900;"></div>
                    <span class="legend-label">E - Very Poor</span>
                    <span class="legend-value">4.5-5.5</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #FF6600;"></div>
                    <span class="legend-label">E+ - Critical</span>
                    <span class="legend-value">5.5-6.5</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #FF3300;"></div>
                    <span class="legend-label">F - Failing</span>
                    <span class="legend-value">6.5-10</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color-box" style="background-color: #CC0000;"></div>
                    <span class="legend-label">F+ - Critical</span>
                    <span class="legend-value">10.0+</span>
                  </div>
                </div>
              </div>
              
              <!-- PLOS Chart Section -->
              <div id="plosChartSection" class="plos-chart-section">
                <div class="plos-chart-title">PLOS Distribution</div>
                
                <!-- Range Slider -->
                <div class="plos-slider-container">
                  <div class="plos-slider-track">
                    <div class="plos-slider-range" id="plosSliderRange"></div>
                  </div>
                  <div class="plos-slider-handle" id="plosHandleLeft"></div>
                  <div class="plos-slider-handle" id="plosHandleRight"></div>
                </div>
                
                <div class="plos-bars-container" id="plosBarsContainer">
                  <!-- Bars will be generated here -->
                </div>
              </div>
              
              <div class="mt-4 p-3 bg-gray-50 rounded border border-gray-200">
                <p class="text-xs text-gray-600">
                  <strong>Note:</strong> Check the boxes above to toggle data layers on the map. 
                  Pedestrian density is shown with a color gradient from yellow (low) to dark brown (high density).
                </p>
              </div>
            </div>
          </div>

          <!-- Intervention Tab -->
          <div id="intervention" class="tab-content hidden space-y-4 text-xs" role="tabpanel">
            <div>
              <h2 class="text-sm font-bold mb-3">Intervention Strategies</h2>
              <p class="text-justify leading-relaxed mb-4">
                Based on pedestrian movement patterns and traffic data analysis, this section outlines 
                potential intervention strategies for improving walkability and safety in the South Bronx.
              </p>
              
              <h3 class="text-xs font-semibold mb-2">Priority Areas</h3>
              <ul class="list-disc pl-5 space-y-2 text-justify">
                <li>High-density pedestrian corridors requiring improved sidewalk infrastructure</li>
                <li>Intersections with elevated safety concerns</li>
                <li>Transit nodes with connectivity gaps</li>
                <li>Underutilized waterfront areas with activation potential</li>
              </ul>
              
              <h3 class="text-xs font-semibold mb-2 mt-4">Design Strategies</h3>
              <ul class="list-disc pl-5 space-y-2 text-justify">
                <li>Pedestrian-priority street redesigns</li>
                <li>Traffic calming measures in residential areas</li>
                <li>Enhanced crossings and wayfinding systems</li>
                <li>Green infrastructure and public space integration</li>
              </ul>
              
              <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                <p class="text-xs text-blue-800">
                  <strong>Coming Soon:</strong> Interactive intervention mapping and design visualization tools 
                  will be added to this section.
                </p>
              </div>
            </div>
          </div>
        </section>
    </aside>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const brandLogo = document.getElementById('brandLogo');
    const expandBar = document.querySelector('.expand-bar');
    const saved = localStorage.getItem('sidebar-collapsed');
    if (saved === 'true') sidebar.classList.add('collapsed');
    
    // Function to toggle sidebar
    const toggleSidebar = () => {
      sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
    };
    
    // Click logo to toggle
    brandLogo.addEventListener('click', toggleSidebar);
    
    // Click thin expand bar to toggle
    expandBar.addEventListener('click', toggleSidebar);

    const railBtns = Array.from(document.querySelectorAll('.rail-btn'));
    const panels = Array.from(document.querySelectorAll('.tab-content'));
    
    function activateTab(id){
      // Auto-expand sidebar if collapsed when clicking a button
      if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        localStorage.setItem('sidebar-collapsed', 'false');
      }
      
      railBtns.forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab === id)));
      panels.forEach(p => p.classList.toggle('hidden', p.id !== id));
    }
    
    railBtns.forEach(b => b.addEventListener('click', () => activateTab(b.dataset.tab)));
    activateTab('background');
  </script>

  <!-- Using Mapbox GL JS (supports both Mapbox and MapTiler) -->
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

  <script>
    // Minimal debug
    const dbg = document.createElement('div');
    dbg.className = 'debug-panel';
    dbg.innerHTML = '<h4>Map debug</h4><div id="debugLog"></div>';
    document.body.appendChild(dbg);
    function debugLog(msg){
      const el = document.getElementById('debugLog');
      const p = document.createElement('div');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.appendChild(p); el.scrollTop = el.scrollHeight; console.log(msg);
    }

    // Mapbox access token (required for Mapbox tilesets)
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuaWVsaGFyaWFudG8iLCJhIjoiY21ncm1kamttMm00ejJsb2tseGlla2NhOCJ9.ZF71BICne61VFpgz1tjYBA';
    
    // MapTiler API key (for basemaps)
    const MAPTILER_KEY = "4Tv5oKoyHjdzVgcIN79S";

    // --- HYBRID LAYER MANAGER (Mapbox Tilesets + MapTiler Basemaps) ---
    class HybridLayerManager {
      constructor(map){
        this.map = map;
        this.layers = {};
        this.visibility = {};
        
        // Re-add layers when style changes
        map.on('styledata', () => {
          setTimeout(() => this.rebuild(), 100);
        });
      }
      
      addTilesetLayer({key, tilesetId, layerId, sourceLayer, type='line', paint={}, layout={}}){
        this.layers[key] = { 
          tilesetId, 
          layerId, 
          sourceLayer, 
          type, 
          paint: {...paint},
          layout: {...layout}
        };
        this.visibility[key] = true;
        this._add(key);
      }
      
      _add(key){
        const l = this.layers[key];
        if (!l) return;
        
        // Remove existing layer if it exists
        if (this.map.getLayer(l.layerId)) {
          this.map.removeLayer(l.layerId);
        }
        
        // Check if source already exists
        const sourceId = `${key}-source`;
        if (!this.map.getSource(sourceId)) {
          this.map.addSource(sourceId, {
            type: 'vector',
            url: `mapbox://${l.tilesetId}`
          });
        }
        
        // Add layer
        this.map.addLayer({
          id: l.layerId,
          type: l.type,
          source: sourceId,
          'source-layer': l.sourceLayer,
          layout: {
            ...l.layout,
            visibility: this.visibility[key] ? 'visible' : 'none'
          },
          paint: l.paint
        });
        
        debugLog(`added tileset layer: ${key} (${l.tilesetId})`);
      }
      
      setVisible(key, visible){
        const l = this.layers[key];
        if (!l || !this.map.getLayer(l.layerId)) return;
        
        this.visibility[key] = visible;
        this.map.setLayoutProperty(l.layerId, 'visibility', visible ? 'visible' : 'none');
      }
      
      rebuild(){
        Object.keys(this.layers).forEach(key => this._add(key));
        debugLog('Tileset layers rebuilt after basemap change');
      }
    }

    // Map initialization with MapTiler basemap
    debugLog('Creating map with MapTiler basemap...');
    const map = new mapboxgl.Map({
      container: "map",
      style: `https://api.maptiler.com/maps/0199c990-d557-79f4-a316-082733fdc6a6/style.json?key=${MAPTILER_KEY}`,
      center: [-73.915, 40.805],
      zoom: 15,
      pitch: 52,
      bearing: 8.6,
      attributionControl: false
    });
    map.addControl(new mapboxgl.NavigationControl(), "top-right");
    map.addControl(new mapboxgl.AttributionControl({ compact: true }));

    const layerManager = new HybridLayerManager(map);

    // Define your Mapbox tileset layers with correct color gradients
    const PEDS_LAYER = {
      key: 'peds',
      tilesetId: 'danielharianto.0s9uqe8g',
      layerId: 'peds-layer',
      sourceLayer: 'pedestrian_density-bed9gf',
      type: 'line',
      paint: {
        'line-color': [
          'step',
          ['get', 'Btw_Rational'],
          '#FFE5D9',  // 0 - 3.5: Very light peach
          3.470, '#FFCCB3',  // 3.5 - 9.9: Light peach
          9.920, '#FFB399',  // 9.9 - 16.4: Light orange
          16.430, '#FF9980',  // 16.4 - 23.7: Medium light orange
          23.720, '#FF8066',  // 23.7 - 31.1: Medium orange
          31.130, '#FF664D',  // 31.1 - 39.2: Orange
          39.180, '#FF4D33',  // 39.2 - 47: Orange-red
          47.010, '#FF331A',  // 47 - 54.8: Red-orange
          54.760, '#E62E00',  // 54.8 - 64: Red
          64.030, '#CC2900',  // 64 - 74.3: Dark red
          74.250, '#B32400',  // 74.3 - 84.6: Darker red
          84.600, '#991F00'   // 84.6+: Very dark red
        ],
        'line-width': 10,
        'line-opacity': 0.9
      },
      layout: {
        'line-join': 'round',
        'line-cap': 'round'
      }
    };

    const VEHICLES_LAYER = {
      key: 'vehicles',
      tilesetId: 'danielharianto.0iqfake1',
      layerId: 'vehicles-layer',
      sourceLayer: 'turck_density_upd-di2urp',
      type: 'line',
      paint: {
        'line-color': [
          'step',
          ['get', '11:00:00'],
          '#FFE5D9',  // 0 - 3.5: Very light peach
          3.470, '#FFCCB3',  // 3.5 - 9.9: Light peach
          9.920, '#FFB399',  // 9.9 - 16.4: Light orange
          16.430, '#FF9980',  // 16.4 - 23.7: Medium light orange
          23.720, '#FF8066',  // 23.7 - 31.1: Medium orange
          31.130, '#FF664D',  // 31.1 - 39.2: Orange
          39.180, '#FF4D33',  // 39.2 - 47: Orange-red
          47.010, '#FF331A',  // 47 - 54.8: Red-orange
          54.760, '#E62E00',  // 54.8 - 64: Red
          64.030, '#CC2900',  // 64 - 74.3: Dark red
          74.250, '#B32400',  // 74.3 - 84.6: Darker red
          84.600, '#991F00'   // 84.6+: Very dark red
        ],
        'line-width': 10,
        'line-opacity': 0.9
      },
      layout: {
        'line-join': 'round',
        'line-cap': 'round'
      }
    };

    const PLOS_LAYER = {
      key: 'plos',
      tilesetId: 'danielharianto.dq3dkrke',
      sourceLayer: 'pedestrian_plos-cdosep'
    };
    
    // Create 8 separate layers for each PLOS grade
    const PLOS_GRADE_LAYERS = [
      {
        key: 'plos-A',
        layerId: 'plos-layer-A',
        grade: 'A',
        color: '#00CC00',  // Green
        min: 0,
        max: 1.5
      },
      {
        key: 'plos-B',
        layerId: 'plos-layer-B',
        grade: 'B',
        color: '#77CC00',  // Yellow-Green
        min: 1.5,
        max: 2.5
      },
      {
        key: 'plos-C',
        layerId: 'plos-layer-C',
        grade: 'C',
        color: '#CCCC00',  // Yellow
        min: 2.5,
        max: 3.5
      },
      {
        key: 'plos-D',
        layerId: 'plos-layer-D',
        grade: 'D',
        color: '#FFCC00',  // Yellow-Orange
        min: 3.5,
        max: 4.5
      },
      {
        key: 'plos-E',
        layerId: 'plos-layer-E',
        grade: 'E',
        color: '#FF9900',  // Orange
        min: 4.5,
        max: 5.5
      },
      {
        key: 'plos-E+',
        layerId: 'plos-layer-E-plus',
        grade: 'E+',
        color: '#FF6600',  // Orange-Red
        min: 5.5,
        max: 6.5
      },
      {
        key: 'plos-F',
        layerId: 'plos-layer-F',
        grade: 'F',
        color: '#FF3300',  // Red
        min: 6.5,
        max: 10.0
      },
      {
        key: 'plos-F+',
        layerId: 'plos-layer-F-plus',
        grade: 'F+',
        color: '#CC0000',  // Dark Red
        min: 10.0,
        max: 100
      }
    ];

    // PLOS Chart functionality
    const plosChartSection = document.getElementById('plosChartSection');
    const plosBarsContainer = document.getElementById('plosBarsContainer');
    const plosHandleLeft = document.getElementById('plosHandleLeft');
    const plosHandleRight = document.getElementById('plosHandleRight');
    const plosSliderRange = document.getElementById('plosSliderRange');
    
    let plosData = [];
    let leftIndex = 0;
    let rightIndex = 7;
    let isDraggingLeft = false;
    let isDraggingRight = false;
    let sliderTrackRect = null;
    
    // PLOS grade definitions with colors
    const PLOS_GRADES = [
      { grade: 'A', min: 0, max: 1.5, color: '#00CC00', label: 'A' },
      { grade: 'B', min: 1.5, max: 2.5, color: '#77CC00', label: 'B' },
      { grade: 'C', min: 2.5, max: 3.5, color: '#CCCC00', label: 'C' },
      { grade: 'D', min: 3.5, max: 4.5, color: '#FFCC00', label: 'D' },
      { grade: 'E', min: 4.5, max: 5.5, color: '#FF9900', label: 'E' },
      { grade: 'E+', min: 5.5, max: 6.5, color: '#FF6600', label: 'E+' },
      { grade: 'F', min: 6.5, max: 10.0, color: '#FF3300', label: 'F' },
      { grade: 'F+', min: 10.0, max: 100, color: '#CC0000', label: 'F+' }
    ];
    
    // Calculate PLOS data from map features
    function calculatePlosData() {
      const features = map.querySourceFeatures('plos-source', {
        sourceLayer: PLOS_LAYER.sourceLayer
      });
      
      const totals = {};
      PLOS_GRADES.forEach(g => totals[g.grade] = 0);
      
      features.forEach(feature => {
        const plosValue = parseFloat(feature.properties.PLOS_Edit) || 0;
        const length = parseFloat(feature.properties.__Length) || 0;
        
        const grade = PLOS_GRADES.find(g => plosValue >= g.min && plosValue < g.max);
        if (grade) {
          totals[grade.grade] += length;
        }
      });
      
      const totalLength = Object.values(totals).reduce((a, b) => a + b, 0);
      
      plosData = PLOS_GRADES.map(g => ({
        grade: g.grade,
        label: g.label,
        color: g.color,
        length: totals[g.grade],
        lengthMiles: (totals[g.grade] * 0.000621371).toFixed(1),
        percent: totalLength > 0 ? ((totals[g.grade] / totalLength) * 100).toFixed(1) : 0
      }));
      
      return plosData;
    }
    
    // Render simple bar chart
    function renderPlosChart() {
      plosBarsContainer.innerHTML = '';
      
      if (plosData.length === 0) return;
      
      const maxLength = Math.max(...plosData.map(d => d.length));
      const maxBarHeight = 100; // Max height in pixels
      
      plosData.forEach((data, index) => {
        const heightPx = maxLength > 0 ? Math.max(5, (data.length / maxLength) * maxBarHeight) : 5;
        
        const barItem = document.createElement('div');
        barItem.className = 'plos-bar-item';
        barItem.dataset.index = index;
        
        // Apply dimmed state if outside range
        if (index < leftIndex || index > rightIndex) {
          barItem.classList.add('dimmed');
        }
        
        const barDiv = document.createElement('div');
        barDiv.className = 'plos-bar-value';
        barDiv.innerHTML = `${data.lengthMiles}k<br>${data.percent}%`;
        
        const barColumn = document.createElement('div');
        barColumn.className = 'plos-bar-column';
        barColumn.style.height = `${heightPx}px`;
        barColumn.style.backgroundColor = data.color;
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'plos-bar-label';
        labelDiv.textContent = data.label;
        
        barItem.appendChild(barDiv);
        barItem.appendChild(barColumn);
        barItem.appendChild(labelDiv);
        
        plosBarsContainer.appendChild(barItem);
      });
      
      updateSliderPosition();
      
      // Apply filter after a short delay to ensure layer is ready
      setTimeout(() => {
        updatePlosFilter();
      }, 100);
      
      console.log('PLOS chart rendered with', plosData.length, 'bars');
    }
    
    // Update slider positions
    function updateSliderPosition() {
      if (!sliderTrackRect || plosData.length === 0) {
        const track = document.querySelector('.plos-slider-track');
        if (track) sliderTrackRect = track.getBoundingClientRect();
        else return;
      }
      
      const trackWidth = sliderTrackRect.width;
      const stepWidth = trackWidth / (plosData.length - 1);
      
      const leftPos = leftIndex * stepWidth;
      const rightPos = rightIndex * stepWidth;
      
      plosHandleLeft.style.left = `${leftPos + 4}px`;
      plosHandleRight.style.left = `${rightPos + 4}px`;
      
      plosSliderRange.style.left = `${leftPos}px`;
      plosSliderRange.style.width = `${rightPos - leftPos}px`;
    }
    
    // Update PLOS layer visibility based on slider selection
    function updatePlosFilter() {
      console.log('Updating PLOS visibility - Range:', leftIndex, 'to', rightIndex);
      
      PLOS_GRADE_LAYERS.forEach((gradeLayer, index) => {
        const layer = map.getLayer(gradeLayer.layerId);
        if (!layer) {
          console.warn('Layer not found:', gradeLayer.layerId);
          return;
        }
        
        // Show if within selected range, hide if outside
        const shouldShow = index >= leftIndex && index <= rightIndex;
        const visibility = shouldShow ? 'visible' : 'none';
        
        map.setLayoutProperty(gradeLayer.layerId, 'visibility', visibility);
        
        console.log(`  Grade ${gradeLayer.grade} (index ${index}):`, shouldShow ? 'VISIBLE' : 'HIDDEN');
      });
      
      // Update bar dimming
      const bars = plosBarsContainer.querySelectorAll('.plos-bar-item');
      bars.forEach((bar, index) => {
        if (index < leftIndex || index > rightIndex) {
          bar.classList.add('dimmed');
        } else {
          bar.classList.remove('dimmed');
        }
      });
    }
    
    // Get index from mouse position
    function getIndexFromPosition(clientX) {
      if (!sliderTrackRect) return 0;
      const relativeX = clientX - sliderTrackRect.left;
      const trackWidth = sliderTrackRect.width;
      const stepWidth = trackWidth / (plosData.length - 1);
      const index = Math.round(relativeX / stepWidth);
      return Math.max(0, Math.min(index, plosData.length - 1));
    }
    
    // Handle mouse move
    function handleSliderMove(e) {
      if (!isDraggingLeft && !isDraggingRight) return;
      
      const newIndex = getIndexFromPosition(e.clientX);
      
      if (isDraggingLeft) {
        leftIndex = Math.min(newIndex, rightIndex);
      } else if (isDraggingRight) {
        rightIndex = Math.max(newIndex, leftIndex);
      }
      
      updateSliderPosition();
      updatePlosFilter();
    }
    
    function handleSliderUp() {
      isDraggingLeft = false;
      isDraggingRight = false;
    }
    
    // Event listeners for handles
    plosHandleLeft.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDraggingLeft = true;
      const track = document.querySelector('.plos-slider-track');
      sliderTrackRect = track.getBoundingClientRect();
    });
    
    plosHandleRight.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDraggingRight = true;
      const track = document.querySelector('.plos-slider-track');
      sliderTrackRect = track.getBoundingClientRect();
    });
    
    document.addEventListener('mousemove', handleSliderMove);
    document.addEventListener('mouseup', handleSliderUp);

    map.on('load', () => {
      // Add all layers in order: Peds, Vehicles, PLOS (8 separate layers)
      layerManager.addTilesetLayer(PEDS_LAYER);
      layerManager.addTilesetLayer(VEHICLES_LAYER);
      
      // Add source for PLOS data (shared by all 8 layers)
      if (!map.getSource('plos-source')) {
        map.addSource('plos-source', {
          type: 'vector',
          url: `mapbox://${PLOS_LAYER.tilesetId}`
        });
      }
      
      // Add 8 separate layers for each PLOS grade
      PLOS_GRADE_LAYERS.forEach(gradeLayer => {
        if (map.getLayer(gradeLayer.layerId)) {
          map.removeLayer(gradeLayer.layerId);
        }
        
        map.addLayer({
          id: gradeLayer.layerId,
          type: 'line',
          source: 'plos-source',
          'source-layer': PLOS_LAYER.sourceLayer,
          filter: [
            'all',
            ['>=', ['get', 'PLOS_Edit'], gradeLayer.min],
            ['<', ['get', 'PLOS_Edit'], gradeLayer.max]
          ],
          paint: {
            'line-color': gradeLayer.color,
            'line-width': 10,
            'line-opacity': 0.9
          },
          layout: {
            'line-join': 'round',
            'line-cap': 'round',
            'visibility': 'none' // Start hidden
          }
        });
        
        console.log('Added PLOS layer:', gradeLayer.layerId, 'for grade', gradeLayer.grade);
      });

      // Wire checkboxes to layer visibility
      const cbPeds = document.getElementById('cbPeds');
      const cbVehicles = document.getElementById('cbVehicles');
      const cbPLOS = document.getElementById('cbPLOS');

      const applyLayerVisibility = () => {
        layerManager.setVisible('peds', cbPeds?.checked);
        layerManager.setVisible('vehicles', cbVehicles?.checked);
        
        // For PLOS, control all 8 grade layers
        const plosVisible = cbPLOS?.checked;
        PLOS_GRADE_LAYERS.forEach(gradeLayer => {
          if (map.getLayer(gradeLayer.layerId)) {
            map.setLayoutProperty(gradeLayer.layerId, 'visibility', plosVisible ? 'visible' : 'none');
          }
        });
        
        debugLog(`Layer visibility - Peds: ${cbPeds?.checked}, Vehicles: ${cbVehicles?.checked}, PLOS: ${cbPLOS?.checked}`);
      };

      // Make checkboxes exclusive - only one can be checked at a time
      cbPeds?.addEventListener('change', () => {
        if (cbPeds.checked) {
          cbVehicles.checked = false;
          cbPLOS.checked = false;
          plosChartSection.classList.remove('active');
        }
        applyLayerVisibility();
        updateLegends();
      });
      
      cbVehicles?.addEventListener('change', () => {
        if (cbVehicles.checked) {
          cbPeds.checked = false;
          cbPLOS.checked = false;
          plosChartSection.classList.remove('active');
        }
        applyLayerVisibility();
        updateLegends();
      });
      
      cbPLOS?.addEventListener('change', () => {
        if (cbPLOS.checked) {
          cbPeds.checked = false;
          cbVehicles.checked = false;
          
          // Show PLOS chart and reset slider
          setTimeout(() => {
            calculatePlosData();
            leftIndex = 0;
            rightIndex = plosData.length - 1;
            renderPlosChart();
            plosChartSection.classList.add('active');
          }, 500);
        } else {
          // Hide chart and reset
          plosChartSection.classList.remove('active');
          leftIndex = 0;
          rightIndex = 7;
        }
        applyLayerVisibility();
        updateLegends();
      });

      applyLayerVisibility();
      updateLegends();
      
      // Add popup handlers for all layers
      setupPopupHandlers();
      
      debugLog('Map loaded with MapTiler basemap and Mapbox tileset layers');
    });
    
    // Update map legends based on active layer
    function updateLegends() {
      const pedestrianLegend = document.getElementById('pedestrianLegend');
      const vehicleLegend = document.getElementById('vehicleLegend');
      const plosLegend = document.getElementById('plosLegend');
      const cbPeds = document.getElementById('cbPeds');
      const cbVehicles = document.getElementById('cbVehicles');
      const cbPLOS = document.getElementById('cbPLOS');
      
      console.log('updateLegends called');
      console.log('Pedestrian checked:', cbPeds?.checked);
      console.log('Vehicle checked:', cbVehicles?.checked);
      console.log('PLOS checked:', cbPLOS?.checked);
      console.log('Legend elements:', {pedestrianLegend, vehicleLegend, plosLegend});
      
      // Hide all legends
      if (pedestrianLegend) pedestrianLegend.classList.remove('active');
      if (vehicleLegend) vehicleLegend.classList.remove('active');
      if (plosLegend) plosLegend.classList.remove('active');
      
      // Show appropriate legend based on active layer
      if (cbPeds?.checked && pedestrianLegend) {
        pedestrianLegend.classList.add('active');
        console.log('Showing pedestrian legend');
      } else if (cbVehicles?.checked && vehicleLegend) {
        vehicleLegend.classList.add('active');
        console.log('Showing vehicle legend');
      } else if (cbPLOS?.checked && plosLegend) {
        plosLegend.classList.add('active');
        console.log('Showing PLOS legend');
      }
    }
    
    // Setup popup handlers for all layers
    function setupPopupHandlers() {
      // Change cursor on hover
      map.on('mouseenter', 'peds-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'peds-layer', () => { map.getCanvas().style.cursor = ''; });
      map.on('mouseenter', 'vehicles-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'vehicles-layer', () => { map.getCanvas().style.cursor = ''; });
      
      // Add mouse handlers for all 8 PLOS grade layers
      PLOS_GRADE_LAYERS.forEach(gradeLayer => {
        map.on('mouseenter', gradeLayer.layerId, () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', gradeLayer.layerId, () => { map.getCanvas().style.cursor = ''; });
      });
      
      // Pedestrian Density popup
      map.on('click', 'peds-layer', (e) => {
        const props = e.features[0].properties;
        const btwRational = parseFloat(props.Btw_Rational) || 0;
        const apUser = parseFloat(props.Apprx) || 0;
        const length = parseFloat(props.__Length) || 0;
        const morningUser = parseFloat(props.Morning) || 0;
        const dayUser = parseFloat(props.Day) || 0;
        const nightUser = parseFloat(props.Night) || 0;
        
        // Round to 2 decimal places
        const apUserRounded = apUser.toFixed(0);
        const lengthRounded = length.toFixed(2);
        const morningRounded = morningUser.toFixed(0);
        const dayRounded = dayUser.toFixed(0);
        const nightRounded = nightUser.toFixed(0);
        
        // Determine class based on Jenks breaks
        let densityClass = '';
        let classColor = '';
        
        if (btwRational < 3.470) {
            densityClass = 'Very Low (0 - 3.5)';
            classColor = '#FFE5D9';
        } else if (btwRational < 9.920) {
            densityClass = 'Low (3.5 - 9.9)';
            classColor = '#FFCCB3';
        } else if (btwRational < 16.430) {
            densityClass = 'Low-Medium (9.9 - 16.4)';
            classColor = '#FFB399';
        } else if (btwRational < 23.720) {
            densityClass = 'Medium (16.4 - 23.7)';
            classColor = '#FF9980';
        } else if (btwRational < 31.130) {
            densityClass = 'Medium-High (23.7 - 31.1)';
            classColor = '#FF8066';
        } else if (btwRational < 39.180) {
            densityClass = 'High (31.1 - 39.2)';
            classColor = '#FF664D';
        } else if (btwRational < 47.010) {
            densityClass = 'Very High (39.2 - 47)';
            classColor = '#FF4D33';
        } else if (btwRational < 54.760) {
            densityClass = 'Extremely High (47 - 54.8)';
            classColor = '#FF331A';
        } else if (btwRational < 64.030) {
            densityClass = 'Critical (54.8 - 64)';
            classColor = '#E62E00';
        } else if (btwRational < 74.250) {
            densityClass = 'Very Critical (64 - 74.3)';
            classColor = '#CC2900';
        } else if (btwRational < 84.600) {
            densityClass = 'Severe (74.3 - 84.6)';
            classColor = '#B32400';
        } else {
            densityClass = 'Extreme (84.6+)';
            classColor = '#991F00';
        }
        
        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <div style="padding: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-width: 200px;">
              <strong style="font-size: 12px; color: #1a1a1a; display: block; margin-bottom: 10px;">Pedestrian Usage</strong>
              <div style="margin: 0 0 10px 0; padding: 10px; background: #f8f8f8; border-radius: 5px;">
                <div style="font-size: 10px; color: #666; margin-bottom: 4px;">Average User / Day</div>
                <strong style="font-size: 16px; color: ${classColor}; line-height: 1.2;">${apUserRounded}</strong>
              </div>
              <div style="margin: 0 0 10px 0; padding: 8px; background: white; border-radius: 5px; border: 1px solid #e8e8e8;">
                <div style="font-size: 10px; color: #666; margin-bottom: 3px;">Density Classification</div>
                <strong style="font-size: 11px; color: ${classColor}; line-height: 1.3;">${densityClass}</strong>
              </div>
              <div style="margin: 0 0 10px 0; padding: 8px; background: white; border-radius: 5px; border: 1px solid #e8e8e8;">
                <div style="font-size: 10px; color: #666; margin-bottom: 3px;">Segment Length</div>
                <strong style="font-size: 11px; color: #1a1a1a;">${lengthRounded} m</strong>
              </div>
              <div style="margin: 0; padding: 10px; background: linear-gradient(135deg, ${classColor}15, ${classColor}08); border-radius: 5px; border-left: 3px solid ${classColor};">
                <strong style="font-size: 11px; color: #333; display: block; margin-bottom: 6px;">Usage by Time Period</strong>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 10px; color: #666;">Morning</span>
                    <strong style="font-size: 11px; color: #1a1a1a;">${morningRounded}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 10px; color: #666;">Day</span>
                    <strong style="font-size: 11px; color: #1a1a1a;">${dayRounded}</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 10px; color: #666;">Night</span>
                    <strong style="font-size: 11px; color: #1a1a1a;">${nightRounded}</strong>
                  </div>
                </div>
              </div>
            </div>
          `)
          .addTo(map);
      });
      
      // Vehicle Density popup
      map.on('click', 'vehicles-layer', (e) => {
        const props = e.features[0].properties;
        const density = parseFloat(props['11:00:00']) || 0;
        const length = parseFloat(props.Shape_Leng) || 0;
        
        // Round to 2 decimal places
        const densityRounded = density.toFixed(2);
        const lengthRounded = length.toFixed(2);
        
        let densityClass = '';
        let classColor = '';
        
        // Match pedestrian Jenks classification with peach-to-red gradient
        if (density < 3.470) {
          densityClass = 'Very Low (0 - 3.5)';
          classColor = '#FFE5D9';
        } else if (density < 9.920) {
          densityClass = 'Low (3.5 - 9.9)';
          classColor = '#FFCCB3';
        } else if (density < 16.430) {
          densityClass = 'Low-Medium (9.9 - 16.4)';
          classColor = '#FFB399';
        } else if (density < 23.720) {
          densityClass = 'Medium (16.4 - 23.7)';
          classColor = '#FF9980';
        } else if (density < 31.130) {
          densityClass = 'Medium-High (23.7 - 31.1)';
          classColor = '#FF8066';
        } else if (density < 39.180) {
          densityClass = 'High (31.1 - 39.2)';
          classColor = '#FF664D';
        } else if (density < 47.010) {
          densityClass = 'Very High (39.2 - 47)';
          classColor = '#FF4D33';
        } else if (density < 54.760) {
          densityClass = 'Extremely High (47 - 54.8)';
          classColor = '#FF331A';
        } else if (density < 64.030) {
          densityClass = 'Critical (54.8 - 64)';
          classColor = '#E62E00';
        } else if (density < 74.250) {
          densityClass = 'Very Critical (64 - 74.3)';
          classColor = '#CC2900';
        } else if (density < 84.600) {
          densityClass = 'Severe (74.3 - 84.6)';
          classColor = '#B32400';
        } else {
          densityClass = 'Extreme (84.6+)';
          classColor = '#991F00';
        }
        
        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <div style="padding: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-width: 200px;">
              <strong style="font-size: 13px; color: #1a1a1a; display: block; margin-bottom: 12px;">Vehicle Density</strong>
              <div style="margin: 0 0 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid ${classColor};">
                <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">Average Density Value</div>
                <strong style="font-size: 16px; color: #212529;">${densityRounded}</strong>
              </div>
              <div style="margin: 0 0 8px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">Classification</div>
                <strong style="font-size: 12px; color: ${classColor};">${densityClass}</strong>
              </div>
              <div style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">Segment Length</div>
                <strong style="font-size: 12px; color: #212529;">${lengthRounded} m</strong>
              </div>
            </div>
          `)
          .addTo(map);
      });
      
      // PLOS popup - handle all 8 grade layers
      const handlePlosClick = (e) => {
        const props = e.features[0].properties;
        const plosValue = parseFloat(props.PLOS_Edit) || 0;
        const length = parseFloat(props.__Length) || 0;
        
        // Round to 2 decimal places
        const plosRounded = plosValue.toFixed(2);
        const lengthRounded = length.toFixed(2);
        
        let losGrade = '';
        let adequacy = '';
        let gradeColor = '';
        
        if (plosValue < 1.5) {
          losGrade = 'A';
          adequacy = 'Excellent - Adequate';
          gradeColor = '#00CC00';
        } else if (plosValue < 2.5) {
          losGrade = 'B';
          adequacy = 'Good - Adequate';
          gradeColor = '#77CC00';
        } else if (plosValue < 3.5) {
          losGrade = 'C';
          adequacy = 'Fair - Marginally Adequate';
          gradeColor = '#CCCC00';
        } else if (plosValue < 4.5) {
          losGrade = 'D';
          adequacy = 'Poor - Inadequate';
          gradeColor = '#FFCC00';
        } else if (plosValue < 5.5) {
          losGrade = 'E';
          adequacy = 'Very Poor - Inadequate';
          gradeColor = '#FF9900';
        } else if (plosValue < 6.5) {
          losGrade = 'E+';
          adequacy = 'Critical - Inadequate';
          gradeColor = '#FF6600';
        } else if (plosValue < 10.0) {
          losGrade = 'F';
          adequacy = 'Failing - Severely Inadequate';
          gradeColor = '#FF3300';
        } else {
          losGrade = 'F+';
          adequacy = 'Critical Failure - Severely Inadequate';
          gradeColor = '#CC0000';
        }
        
        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <div style="padding: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-width: 220px;">
              <strong style="font-size: 13px; color: #1a1a1a; display: block; margin-bottom: 12px;">Pedestrian Level of Service</strong>
              <div style="margin: 0 0 12px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">PLOS Score</div>
                  <strong style="font-size: 16px; color: #212529;">${plosRounded}</strong>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">Grade</div>
                  <strong style="font-size: 24px; color: ${gradeColor}; font-weight: bold;">${losGrade}</strong>
                </div>
              </div>
              <div style="margin: 0 0 8px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid ${gradeColor};">
                <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">Service Level</div>
                <strong style="font-size: 11px; color: #212529; line-height: 1.4;">${adequacy}</strong>
              </div>
              <div style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 10px; color: #6c757d; margin-bottom: 4px;">Segment Length</div>
                <strong style="font-size: 12px; color: #212529;">${lengthRounded} m</strong>
              </div>
            </div>
          `)
          .addTo(map);
      };
      
      // Add click handler to all 8 PLOS grade layers
      PLOS_GRADE_LAYERS.forEach(gradeLayer => {
        map.on('click', gradeLayer.layerId, handlePlosClick);
      });
    }

    // Basemap switcher using MapTiler styles
    const BASEMAPS = [
      { 
        id: "satellite", 
        label: "satellite", 
        style: `https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY}`, 
        thumb: "./assets/02_Earth.png" 
      },
      { 
        id: "OSM", 
        label: "street map", 
        style: `https://api.maptiler.com/maps/openstreetmap/style.json?key=${MAPTILER_KEY}`, 
        thumb: "./assets/01_Hybrid.png" 
      },
      { 
        id: "pastel", 
        label: "pastel", 
        style: `https://api.maptiler.com/maps/0199c990-d557-79f4-a316-082733fdc6a6/style.json?key=${MAPTILER_KEY}`, 
        thumb: "./assets/03_Pastel.png" 
      }
    ];

    const bmPanel = document.createElement('div');
    bmPanel.id = "bmPanel";
    bmPanel.className = "flex md:flex-col gap-2 md:hover:flex md:hover:scale-100 transition origin-bottom-right md:group-hover:scale-100 md:scale-100";

    const bmCtrl = document.createElement('div');
    bmCtrl.id = "basemapCtrl";
    bmCtrl.className = "absolute bottom-10 right-4 z10";
    bmCtrl.innerHTML = `
      <div class="group relative">
        <button id="bmToggle"
          class="md:hidden mb-2 grid h-10 w-10 place-items-center rounded-md bg-white/90 shadow border border-neutral-200">
          <span class="text-xs">BM</span>
        </button>
      </div>
    `;
    bmCtrl.querySelector('.group').appendChild(bmPanel);
    document.body.appendChild(bmCtrl);

    const bmToggle = document.getElementById("bmToggle");
    let open = false;
    bmToggle?.addEventListener("click", () => {
      open = !open;
      bmPanel.classList.toggle("hidden", !open);
    });
    const isMobile = () => matchMedia("(max-width: 767px)").matches;
    const setInitialVisibility = () => bmPanel.classList.toggle("hidden", isMobile());
    setInitialVisibility();
    addEventListener("resize", setInitialVisibility);

    let activeId = "pastel";
    BASEMAPS.forEach(({ id, label, thumb, style }) => {
      const btn = document.createElement("button");
      btn.className = [
        "relative overflow-hidden rounded-md border border-neutral-300 bg-white shadow",
        "hover:shadow-md focus:outline-none focus:ring focus:ring-blue-400/30",
        "w-16 h-16 md:w-20 md:h-20"
      ].join(" ");
      btn.setAttribute("data-style", style);
      btn.setAttribute("data-id", id);
      btn.title = label;
      btn.innerHTML = `
        <img src="${thumb}" alt="${label}" class="absolute inset-0 w-full h-full object-cover">
        <span class="absolute bottom-0 left-0 right-0 text-[10px] md:text-xs bg-black/60 text-white px-1 py-0.5">${label}</span>
      `;
      if (id === activeId) btn.classList.add("ring", "ring-blue-500");

      btn.addEventListener("click", () => {
        if (id === activeId) return;
        
        const center = map.getCenter();
        const zoom = map.getZoom();
        const bearing = map.getBearing();
        const pitch = map.getPitch();
        
        const visibilityStates = {};
        Object.keys(layerManager.layers).forEach(key => {
          visibilityStates[key] = layerManager.visibility[key];
        });
        
        map.setStyle(style);
        
        map.once('styledata', () => {
          map.jumpTo({ center, zoom, bearing, pitch });
          
          Object.keys(layerManager.layers).forEach(key => {
            layerManager._add(key);
            layerManager.setVisible(key, visibilityStates[key]);
          });
          
          // Re-add popup handlers after basemap change
          setTimeout(() => setupPopupHandlers(), 200);
        });
        
        bmPanel.querySelectorAll("button").forEach(b => b.classList.remove("ring", "ring-blue-500"));
        btn.classList.add("ring", "ring-blue-500");
        activeId = id;
        if (isMobile()) { 
          open = false; 
          bmPanel.classList.add("hidden"); 
        }
        
        debugLog(`Switched to ${label} basemap`);
      });

      bmPanel.appendChild(btn);
    });
  </script>

  <!-- Landing overlay -->
  <div id="landing" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-md">
    <div class="w-[min(92vw,580px)] rounded-2xl bg-white/80 border border-white/60 shadow-xl p-6">
      <div class="flex items-center justify-between gap-4 mb-4 pb-4 border-b-2 border-black">
        <div class="flex items-center gap-4">
          <img src="./assets/MIT.svg" alt="MIT" class="h-8 w-auto scale-[0.8]" />
          <div class="flex items-center gap-3">
            <img src="./assets/SA+P.svg" alt="SA+P" class="h-8 w-auto ml-[-20px] scale-[0.7]" />
            <img src="./assets/SBX.svg" alt="SBX" class="h-8 w-auto ml-[200px] scale-[1.3]" />
          </div>
        </div>
      </div>
      
      <div class="disclaimer__content">
        <div class="disclaimer__item">
          <h3>Identification</h3>
          <p>
            This web map is developed to identify traffic and pedestrian density patterns in the South Bronx
            and to support design strategies for safer, more accessible streets.
          </p>
        </div>

        <div class="disclaimer__item">
          <h3>Use</h3>
          <p>
            The map is intended for planning and design exploration only. It helps visualize where movement
            demand is concentrated and highlights areas that may require improvement (e.g., safety, comfort,
            connectivity). Results should be interpreted as indicatorsnot as precise measurements of real-time
            conditions.
          </p>
        </div>

        <div class="disclaimer__item">
          <h3>Source</h3>
          <p>
            This work is based on collective research and publicly available datasets, primarily from NYC Open Data
            and related open data sources. Data accuracy, completeness, and timeliness may vary by dataset and
            update cycle.
          </p>
        </div>

        <div class="disclaimer__item">
          <h3>Notes</h3>
          <p>
            Street conditions may change over time due to construction, seasonal patterns, or policy updates.
            Users should supplement this map with field observation and community input when making decisions.
          </p>
        </div>
      </div>
      
      <div class="flex items-center gap-2">
        <button id="enterBtn" class="inline-flex items-center justify-center rounded-lg bg-black text-white px-4 py-2 font-medium hover:bg-black/90">Enter</button>
      </div>
    </div>
  </div>
  <script>
    const landing = document.getElementById('landing');
    const enterBtn = document.getElementById('enterBtn');
    if (sessionStorage.getItem('skip-landing') === '1') landing.classList.add('hidden');
    function closeLanding(){ landing.classList.add('hidden'); }
    enterBtn.addEventListener('click', closeLanding);
  </script>
  
</body>
</html>
